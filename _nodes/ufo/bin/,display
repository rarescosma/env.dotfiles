#!/usr/bin/env bash

,default() {
  ,external
  feh --no-fehbg --bg-fill --geometry +0+640 ~/media/wallpapers/dark-forest.jpg
}

,external() {
  _update_default external

  xrandr --auto --output eDP-1-2 --off --output eDP-1-1 --off

  ,wm dpi::terminal 11
  ,wm dpi::i3 10
  ,wm dpi::gtk 10
  ,wm dpi::idea 18 16
  ,wm dpi::x 110
  ,wm dpi::rofi 12
}

,blackbird() {
  _update_default blackbird

  local attempt_num=0
  local max_attempts=5

  while ! xrandr \
    --output DP-0 --primary --mode 3440x1440 --rate 165.0 --pos 2560x0 --rotate normal \
    --output DP-2 --mode 2560x1440 --rate 239.97 --pos 0x0 --rotate normal \
    --output DP-1 --off --output HDMI-0 --off \
    --output DP-3 --off --output DP-4 --off && [ $attempt_num -lt $max_attempts ]; do
      sleep 1
      attempt_num=$(( attempt_num + 1 ))
  done

  ,wm dpi::terminal 7
  ,wm dpi::i3 7
  ,wm dpi::x 144
  ,wm dpi::rofi 11
  ,wm dpi::idea 14 17 1.3
}

,internal() {
  _update_default internal

  xrandr --output DP-2 --primary --mode 2560x1440 --rate 59.95 --pos 0x0 --rotate normal \
    --output VIRTUAL1 --off  \
    --output DP1 --off \
    --output HDMI2 --off \
    --output HDMI1 --off \
    --output DP2 --off \
    --output DP-0 --off

  ,wm dpi::terminal 11
  ,wm dpi::i3 9 
  ,wm dpi::gtk 12
  ,wm dpi::idea 20 22 1.7
  ,wm dpi::x 144
  ,wm dpi::rofi 18
}

_update_default() {
  local display="${1:-}"
  test -z "$display" && return

  sed "s/^export DEFAULT_DISPLAY=.*$/export DEFAULT_DISPLAY=\",${display}\"/" -i ~/.local/env
}

(return 0 2>/dev/null) && sourced=1 || sourced=0

# don't dispatch if we're being sourced
if [[ "$sourced" == "0" ]]; then
  test -z "${SYSTEMD_EXEC_PID:-}" && exec 2> >(tee -a /dev/stderr)
  "$@"

  feh --no-fehbg --bg-fill ~/media/wallpapers/dark-forest.jpg
fi
