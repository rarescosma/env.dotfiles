#!/usr/bin/env python3
from collections import defaultdict
import json
import os
import shlex
from subprocess import check_output
import time

HOME = os.getenv("HOME", "")


def main():
    env = json.loads(check_output("mise env --json-extended".split()))
    pairs = {k: v for k, v in env.items() if "tool" not in v and "source" in v}

    by_source = defaultdict(list)
    for k, v in pairs.items():
        by_source[v["source"]].append((k, v["value"]))

    for k in by_source:
        by_source[k].sort(key=lambda p: p[0])

    first = True
    for source, envs in by_source.items():
        if not first:
            print("")
        else:
            first = False
        print(f"# source: {source.replace(HOME,'~')} ({time.time_ns()})")
        for key, val in envs:
            print(f"export {shlex.quote(key)}={shlex.quote(val)}")


if __name__ == "__main__":
    main()
