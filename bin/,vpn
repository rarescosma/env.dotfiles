#!/usr/bin/env bash

,vps-wg() {
  ,off
  ,tomb ,open || exit 1
  sudo rm -f /etc/wireguard/wg0vps.conf
  sudo ln -sf /tomb/wireguard/$(hostname -s).conf /etc/wireguard/wg0vps.conf
  sudo wg-quick up wg0vps
}

openvpn() {
  local to_who log_path
  test -z "$1" && return 1
  to_who="$1"

  ,off
  ,tomb ,open || exit 1
  log_path="/tmp/ovpn-${to_who}.log"

  sudo bash -c "openvpn --config /tomb/var/ovpn/${to_who}/$(hostname -s).ovpn --mute-replay-warnings --daemon '${to_who}' --log '${log_path}'"
}

,vps() {
  openvpn vps
}

,seedbox() {
  openvpn seedbox
}

,brewer() {
  openvpn brewer
}

,off() {
  sudo -E pkill -f openvpn
  sudo wg-quick down wg0vps 2>/dev/null || true
}

(return 0 2>/dev/null) && sourced=1 || sourced=0

# don't dispatch if we're being sourced
if [[ "$sourced" == "0" ]]; then
  $@
fi
